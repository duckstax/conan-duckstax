name: Build & Upload

env:
  CONAN_REMOTE: otterbrix
  CONAN_REMOTE_URL: http://conan.otterbrix.com

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      force_upload:
        description: 'Force upload to remote'
        required: false
        default: false
        type: boolean
      package:
        description: 'Package to build (empty = all)'
        required: false
        type: string
      version:
        description: 'Version to build (empty = latest)'
        required: false
        type: string

jobs:
  # ============================================
  # Stage 1: Lint
  # ============================================
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run YAML lint
        run: yamllint -c linter/.yamllint.yml recipes/

  validate-recipes:
    name: Validate Recipes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r linter/requirements.txt

      - name: Validate recipes
        run: python linter/check_recipes.py recipes/

  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pylint
        run: pip install pylint conan

      - name: Lint conanfile.py
        run: |
          find recipes -name "conanfile.py" | xargs pylint \
            --disable=all \
            --enable=E0001,E0100,E0101,E0102,E0103,E0104,E0105,E0107,E0108 \
            --exit-zero

  # ============================================
  # Stage 2: Build all packages (per OS)
  # ============================================
  build:
    name: Build (${{ matrix.os }})
    needs: [yaml-lint, validate-recipes, python-lint]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-15]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install and setup Conan
        uses: conan-io/setup-conan@v1
        with:
          version: "2.14.0"
          cache_packages: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Configure Conan
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_LOGIN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        run: |
          conan profile detect --force

          # Ensure conancenter is available for pre-built dependencies
          conan remote add conancenter https://center2.conan.io --force || true

          # Add otterbrix remote
          conan remote add ${{ env.CONAN_REMOTE }} ${{ env.CONAN_REMOTE_URL }} --force || true
          conan remote login ${{ env.CONAN_REMOTE }} "$CONAN_LOGIN_USERNAME" -p "$CONAN_PASSWORD"

      - name: Build all packages in dependency order
        env:
          PACKAGE_FILTER: ${{ github.event.inputs.package }}
          VERSION_FILTER: ${{ github.event.inputs.version }}
        run: |
          python scripts/build_packages.py recipes/ \
            --upload=${{ (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event.inputs.force_upload == 'true' }}
