name: Build & Upload

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to build (empty = all)'
        required: false
        type: string
      version:
        description: 'Version to build (empty = latest)'
        required: false
        type: string

jobs:
  # ============================================
  # Stage 1: Lint
  # ============================================
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run YAML lint
        run: yamllint -c linter/.yamllint.yml recipes/

  validate-recipes:
    name: Validate Recipes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r linter/requirements.txt

      - name: Validate recipes
        run: python linter/check_recipes.py recipes/

  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pylint
        run: pip install pylint conan

      - name: Lint conanfile.py
        run: |
          find recipes -name "conanfile.py" | xargs pylint \
            --disable=all \
            --enable=E0001,E0100,E0101,E0102,E0103,E0104,E0105,E0107,E0108 \
            --exit-zero

  # ============================================
  # Stage 2: Generate valid build matrix
  # ============================================
  generate-matrix:
    name: Generate matrix
    runs-on: ubuntu-latest
    needs: [yaml-lint, validate-recipes, python-lint]
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml conan

      - name: Setup Conan
        run: conan profile detect --force

      - name: Generate build matrix
        id: generate
        run: |
          ARGS="recipes"

          if [ -n "${{ github.event.inputs.package }}" ]; then
            ARGS="$ARGS --package ${{ github.event.inputs.package }}"
          fi

          if [ -n "${{ github.event.inputs.version }}" ]; then
            ARGS="$ARGS --version ${{ github.event.inputs.version }}"
          fi

          # Generate matrix using conan graph info for validation
          MATRIX=$(python scripts/generate_matrix.py $ARGS --output json)

          # Output as single line for GitHub Actions
          echo "matrix=$(echo "$MATRIX" | jq -c .)" >> $GITHUB_OUTPUT

          echo "Generated matrix:"
          echo "$MATRIX" | jq .

  # ============================================
  # Stage 3: Build (only valid combinations)
  # ============================================
  build:
    name: ${{ matrix.name }}/${{ matrix.version }} (${{ matrix.os }}${{ matrix.cxx_standard && format(', C++{0}', matrix.cxx_standard) || '' }})
    needs: generate-matrix
    if: ${{ needs.generate-matrix.outputs.matrix != '[]' && needs.generate-matrix.outputs.matrix != '' }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install and setup Conan
        uses: conan-io/setup-conan@v1
        with:
          version: "2.14.0"
          cache_packages: true

      - name: Configure Conan
        env:
          CONAN_REMOTE_URL: ${{ secrets.CONAN_REMOTE_URL }}
          CONAN_USER: ${{ secrets.CONAN_USER }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        run: |
          conan profile detect --force

          if [ -n "$CONAN_REMOTE_URL" ]; then
            conan remote add upload "$CONAN_REMOTE_URL" --force || true
            conan remote login upload "$CONAN_USER" -p "$CONAN_PASSWORD"
          fi

      - name: Export all local recipes
        run: |
          # Export all recipes so dependencies can be built from source
          python scripts/export_recipes.py recipes/

      - name: Build ${{ matrix.name }}
        run: |
          OPTIONS=""
          if [ -n "${{ matrix.cxx_standard }}" ]; then
            OPTIONS="-o ${{ matrix.name }}/*:cxx_standard=${{ matrix.cxx_standard }}"
          fi

          conan create recipes/${{ matrix.name }}/all \
            --version="${{ matrix.version }}" \
            --build=missing \
            $OPTIONS \
            -s build_type=${{ matrix.build_type }}

      - name: Upload ${{ matrix.name }}
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        env:
          CONAN_REMOTE_URL: ${{ secrets.CONAN_REMOTE_URL }}
        run: |
          if [ -n "$CONAN_REMOTE_URL" ]; then
            conan upload "${{ matrix.name }}/${{ matrix.version }}:*" \
              -r=upload --confirm || true
          fi
